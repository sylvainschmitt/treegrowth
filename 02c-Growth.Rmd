```{r setupgrowthc, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(greta)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Growth `greta` lognormal

For the third model we used a lognormal likelihood that we sampled with the HMC  algorithm and variational inference using `greta`. 
Specifically, we used the following model to estimate individual growth potential:

\begin{equation} 
  log(DBH_{y=today,s,i}  - DBH_{y=y0,s,i}) \sim \\
  \mathcal{N} (log\theta_{1,s,i} + log(\sum _{y=y_0} ^{y=today} .exp(-\frac12.[\frac{log(\frac{DBH_{y,s,i}}{100.\theta_{2,s}})}{\theta_{3,s}}]^2)), \sigma_1) \\ 
  log \theta_{1,s,i}) \sim \mathcal {N}(log\theta_{1,s}, \sigma_2) \\ 
  log(\theta_{2,s}) \sim \mathcal {N}(log(\theta_2),\sigma_3) \\ 
  log(\theta_{3,s}) \sim \mathcal {N}(log(\theta_3),\sigma_4) \\
  ~ \\
  (\theta_2, \theta_3) \sim \mathcal{logN}(log(1),1) \\ 
  (log\theta_{1,s}, \sigma_1, \sigma_2, \sigma_3, \sigma_4) \sim \mathcal{N}_T(0,1) \\ 
  (\#eq:gmax3)
\end{equation} 

The sampling took only 15 minutes (Tab. \@ref(tab:timec)) with chains correctly mixing but encompassing static state (Fig. \@ref(fig:traceplotc)) and relatively no correlations among parameters (Fig. \@ref(fig:pairsc)). 
We obtained correct and varying species (Fig. \@ref(fig:thetasc)) and individual (Fig. \@ref(fig:thetaic)) growth potentials.

```{r samplingc, eval=F}
load("save/mdata.Rdata")

# variables & priors
thetas1 <- lognormal(0, 1, dim = mdata$S, truncation = c(0, 1))
thetas2 <- lognormal(0, 1, dim = mdata$S, truncation = c(0, 1))
thetas3 <- lognormal(0, 1, dim = mdata$S, truncation = c(0, 1))
sigma <- normal(0, 1, truncation = c(0, Inf))

# predictor
DBH <- rep(1, mdata$I)
for(t in 1:mdata$Y) {
  DBH[mdata$Y0 == mdata$years[t]] <- mdata$DBH0[mdata$Y0 == mdata$years[t]]
  DBH <- DBH + thetas1[mdata$species]*exp(-0.5* (log(DBH / (100*thetas2[mdata$species])) / thetas3[mdata$species])^2)
}

# likelihood
distribution(mdata$DBHtoday) <- lognormal(log(DBH), sigma)

# generate quantities
thetai1 <- thetas1[mdata$species] + mdata$DBHtoday - DBH

# model
m <- model(thetai1, thetas1, sigma)

# sampling
fit <- mcmc(m, n_samples = 2000, chains = 2)

save(time, data, mdata, fit, file = "model/gmax3.Rdata")
```

```{r fitc}
load("model/gmax3.Rdata")
```

```{r timec}
data.frame("Total" = "< 15 minutes") %>% 
  kable(caption = "Elapsed time to fit 187 trees over 37 years and 3 species in the plot 14 of Paracou.")
```

```{r traceplotc, fig.cap="Trace plot."}
mcmc_trace(fit, pars = c("thetai1[1,1]", "thetas1[1,1]", "sigma"), nrow = 3)
```

```{r pairsc, fig.cap="Pairs plot."}
mcmc_pairs(fit, pars = c("thetai1[1,1]", "thetas1[1,1]", "sigma"))
```

```{r thetasc, fig.cap="Posteriors for species growth potentials."}
mcmc_intervals(fit, pars = paste0("thetas1[", 1:mdata$S, ",1]"))
```

```{r thetaic, fig.cap="Posteriors for individual growth potentials."}
mcmc_intervals(fit, pars = paste0("thetai1[", 1:mdata$I, ",1]")) +
  theme(axis.text.y = element_blank())
```
