```{r setupgrowtredgreta, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(greta)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Growth reduced `greta`

For the second model we used a lognormal likelihood that we sampled with the HMC  algorithm and variational inference using `greta`. 
Specifically, we used the following model to estimate individual growth potential:

\begin{equation} 
  DBH_{y=today,s,i}  - DBH_{y=y0,s,i} \sim \\
  \mathcal{logN} (log(\theta_{1,s} \times \sum _{y=y_0} ^{y=today} exp(-\frac12.[\frac{log(\frac{DBH_{y,s,i}}{100.\theta_{2,s}})}{\theta_{3,s}}]^2)), \sigma_1) \\ 
  ~ \\
  (\theta_{1,s}, \theta_{2,s}, \theta_{3,s}) \sim \mathcal{logN}^{3 \times S}(log(1),1) \\ 
  \sigma \sim \mathcal{N}_T(0,1) \\ 
  ~ \\
  \theta_{1,s,i} = \frac{DBH_{y=today,s,i}}{\sum_{y=y0}^{y=2020} exp(-\frac12.[\frac{log(\frac{DBH_{y,s,i}}{100.\theta_{2,s}})}{\theta_{3,s}}]^2)} \\ 
    (\#eq:gmax2)
\end{equation} 

The sampling took only 15 minutes (Tab. \@ref(tab:timec)) with chains correctly mixing but encompassing static state (Fig. \@ref(fig:traceplotc)) and relatively no correlations among parameters (Fig. \@ref(fig:pairsc)). 
We obtained correct and varying species (Fig. \@ref(fig:thetasc)) and individual (Fig. \@ref(fig:thetaic)) growth potentials.

```{r samplingredgreta, eval=F}
# data
trees <- vroom::vroom("save/mdata_reduced.tsv", show_col_types = F) 
mdata <- list(I = nrow(trees),
              Y = 2020 - min(trees$Y0) + 1,
              S = max(trees$speciesNum),
              years = min(trees$Y0):2020,
              DBH0 = trees$DBH0,
              Y0 = trees$Y0,
              DBHtoday = trees$DBHtoday + 10^-6,
              species = trees$speciesNum)

# variables & priors
thetas <- lognormal(0, 1, dim = c(mdata$S, 3), truncation = c(0, 3))
sigma <- normal(0, 1, truncation = c(0, Inf))

# predictor
Sigma <- rep(1, mdata$I)
for(t in 1:mdata$Y) {
  Sigma[mdata$Y0+1 == mdata$years[t]] <- mdata$DBH0[mdata$Y0+1 == mdata$years[t]]
  Sigma <- Sigma + exp(-0.5* (log(Sigma / (100*thetas[mdata$species,2])) / thetas[mdata$species,3])^2)
}
Sigma <- Sigma - mdata$DBH0

# likelihood
DeltaDBH <- mdata$DBHtoday - mdata$DBH0
distribution(DeltaDBH) <- lognormal(log(thetas[mdata$species,1]*Sigma), sigma)

# generate quantities
thetai <- mdata$DBHtoday / Sigma

# model
m <- model(thetai, thetas, sigma)

# sampling
fit <- mcmc(m, warmup = 1000, n_samples = 1000, chains = 2)

# save
save(data, mdata, fit, file = "save/gmax_greta_reduced.Rdata")
```

```{r fitredredgreta}
load("save/gmax_greta_reduced.Rdata") 
```

```{r traceplotredredgreta, fig.cap="Trace plot."}
mcmc_trace(fit, pars = c("thetas[1,1]", "thetas[1,2]", "thetas[1,3]", "sigma"))  
```

```{r pairsredgreta, fig.cap="Pairs plot."}
mcmc_pairs(fit, pars = c("thetas[1,1]", "thetas[1,2]", "thetas[1,3]", "sigma"))  
```

```{r thetasredgreta, fig.cap="Posteriors for species growth potentials."}
mcmc_intervals(fit, pars = paste0("thetas[", 1:mdata$S, ",1]"))  
```

```{r thetairedgreta, fig.cap="Posteriors for individual growth potentials."}
mcmc_intervals(fit, pars = paste0("thetai[", 1:mdata$I, ",1]")) +
  theme(axis.text.y = element_blank())  
```
