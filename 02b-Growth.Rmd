```{r setupgrowthb, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(rstan)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
```

# Growth `stan` normal

For the second model we used a normal likelihood that we sampled with the NUTS algorithm using `stan`. 
Specifically, we used the following model to estimate individual growth potential:

\begin{equation} 
  log(DBH_{y=today,s,i}  - DBH_{y=y0,s,i}) \sim \\
  \mathcal{N} (\hat{log\theta_{1,s,i}} + log(\sum _{y=y_0} ^{y=today} exp(-\frac12.[\frac{log(\frac{DBH_{y,s,i}}{100.\hat{\theta_{2,s}}})}{\hat{\theta_{3,s}}}]^2)), \sigma_1) \\ 
  \hat{\theta_{1,s,i}} = log\theta_{1,s} + \sigma_2.\epsilon_{1,i} \\ 
  \hat{\theta_{2,s}}  = e^{log(\theta_2) + \sigma_3.\epsilon_{2,s}} \\ 
  \hat{\theta_{3,s}}  = e^{log(\theta_3) + \sigma_4.\epsilon_{3,s}} \\  
  \epsilon_{1,i} \sim \mathcal{N}(0,1) \\
  \epsilon_{2,s} \sim \mathcal{N}(0,1) \\
  \epsilon_{3,s} \sim \mathcal{N}(0,1) \\
  ~ \\
  (\theta_2, \theta_3) \sim \mathcal{logN}(log(1),1) \\ 
  (log\theta_{1,s}, \sigma_1, \sigma_2, \sigma_3, \sigma_4) \sim \mathcal{N}_T(0,1) \\ 
  (\#eq:gmax2stan)
\end{equation} 

The sampling took up to 59 minutes (Tab. \@ref(tab:timeb)) with chains correctly mixing (Fig. \@ref(fig:traceplotb)) and relatively no correlations among parameters (Fig. \@ref(fig:pairsb)). 
We obtained correct and varying species (Fig. \@ref(fig:thetasb)) and individual (Fig. \@ref(fig:thetaib)) growth potentials.

```{r samplingb, eval=F}
load("save/mdata.Rdata")
model <- stan_model("model/gmax2.stan")
fit <- sampling(model, chains = 2, data = mdata, save_warmup = F, control = list(adapt_delta = 0.99, max_treedepth = 12),
                include = F, pars = c("epsilon_s2", "epsilon_s3", "epsilon_i", "DBH"))
save(data, mdata, fit, file = "model/gmax2.Rdata"))
```

```{r fitb}
load("model/gmax2.Rdata")
```

```{r timeb}
get_elapsed_time(fit) %>% 
  as.data.frame() %>% 
  rownames_to_column("chain") %>% 
  mutate(total = warmup + sample) %>% 
  mutate_at(c("warmup", "sample", "total"), lubridate::seconds_to_period) %>% 
  kable(caption = "Elapsed time to fit 187 trees over 37 years and 3 species in the plot 14 of Paracou.")
```

```{r traceplotb, fig.cap="Trace plot."}
mcmc_trace(fit, pars = c("thetai1[1]", "thetas1[1]", "sigma", "lp__"), np = nuts_params(fit))
```

```{r pairsb, fig.cap="Pairs plot."}
mcmc_pairs(fit, pars = c("thetai1[1]", "thetas1[1]", "sigma"), np = nuts_params(fit))
```

```{r thetasb, fig.cap="Posteriors for species growth potentials."}
mcmc_intervals(fit, pars = paste0("thetas1[", 1:mdata$S, "]"))
```

```{r thetaib, fig.cap="Posteriors for individual growth potentials."}
mcmc_intervals(fit, pars = paste0("thetai1[", 1:mdata$I, "]")) +
  theme(axis.text.y = element_blank())
```
