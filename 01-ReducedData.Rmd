```{r datareduced, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(gganimate)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```

# Reduced data

To define the models we first worked on a reduced dataset.
We used the full `Guyafor` database that we recoded in `SQL` for faster quesry using `dbplyr`.
We focused on the variation in diameter of trees across censuses in the plot 6 of individuals >20m from an edge to avoid edge effect in the neighbourhood crowding index.
We chose to keep individuals with at least 10 censuses and species with at least 10 individuals (Fig. \@ref(fig:datareffig)).
To gain time, we further reduced the dataset (Tab \@ref(tab:dataredcar)).

```{r datatypes, eval=F}
load("data/Guyafor_Bota.RData")
vroom::vroom_write(Guyafor, "data/guyafor.csv", delim = ",")
csv2sql::csv_to_sqlite(csv_name = "data/guyafor.csv", db_name = "data/guyafor.sql", table_name = "inventory")
unlink("data/guyafor.csv")
```

```{r dataredprep}
guyafor <- DBI::dbConnect(RSQLite::SQLite(), dbname = "data/guyafor.sql")
trees <- tbl(guyafor, "inventory") %>% 
  filter(Forest == "Paracou") %>% 
  filter(Plot == "6") %>% 
  collect() %>% 
  filter(Xfield > 20, Xfield < 250-20, Yfield > 20, Yfield < 250-20) %>% 
  mutate(species = paste(Genre, Espece)) %>% 
  filter(!grepl("Indet", species)) %>% 
  mutate(speciesNum = as.numeric(as.factor(species))) %>% 
  mutate(DBH = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  mutate(Y0 = first(CensusYear)) %>% 
  mutate(DBH0 = first(DBH)) %>% 
  mutate(Ytoday = last(CensusYear)) %>% 
  mutate(DBHtoday = last(DBH)) %>% 
  group_by(Forest, Plot, SubPlot, TreeFieldNum, idTree, Xfield, Yfield, Xutm, Yutm, Family, Genus, Species,
           species, speciesNum, Y0, DBH0, Ytoday, DBHtoday) %>% 
  summarise(N = n()) %>% 
  filter(Ytoday == 2020) %>% 
  filter(DBHtoday > DBH0)
DBI::dbDisconnect(guyafor) ; rm(guyafor)
```

```{r dataredfig, fig.cap="Caption."}
cowplot::plot_grid(
  trees %>% 
    ggplot(aes(N)) +
    geom_histogram() +
    scale_y_log10() +
    geom_vline(xintercept = 10, col = "red") +
    xlab("Censuses per individual") +
    ggtitle(paste(round(nrow(filter(trees, N > 10))/nrow(trees)*100, 1), "% > 10")),
  trees %>% 
    group_by(species) %>% 
    summarise(N = n()) %>% 
    ggplot(aes(N)) +
    geom_histogram() +
    scale_y_log10() +
    scale_x_log10() +
    geom_vline(xintercept = 10, col = "red") +
    xlab("Individuals per species") +
    ggtitle(paste(round(nrow(filter(summarise(group_by(trees, species), N = n()), N > 10))/nrow(summarise(group_by(trees, species), N = n()))*100, 1), "% > 10")),
  trees %>% 
    ggplot(aes(Ytoday - Y0, DBHtoday - DBH0)) +
    geom_point() +
    xlab(expression(Delta[Y])) + ylab(expression(Delta[DBH]))
)
```

```{r dataredfilt, eval=F}
trees %>% 
  group_by(species) %>% 
  mutate(Nsp = n()) %>% 
  filter(N > 10, Nsp > 10) %>% 
  ungroup() %>%  
  filter(species %in% sample(unique(.$species), 1)) %>% 
  sample_n(10) %>% 
  mutate(speciesNum = as.numeric(as.factor(species))) %>% 
  vroom::vroom_write("save/mdata_reduced.tsv")
```

```{r dataredcar}
vroom::vroom("save/mdata_reduced.tsv") %>% 
  summarise(individuals = nrow(.), 
            species = length(unique(species)),
            genus = length(unique(Genus)),
            family = length(unique(Family)),
            years = max(Ytoday)-min(Y0)+1) %>% 
  reshape2::melt() %>% 
  kable(caption = "Reduced data cahracterstics.", col.names = c("", "N")) 
```
