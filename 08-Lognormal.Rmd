```{r log, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(greta)
library(ggtree)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Lognormal

Using time $t$ since recruitment (DBH=10cm) for each individual tree $i$:

$$DBH_{i,t} \sim \mathcal N (10 +\beta \times log(t), \sigma)$$

```{r log2data}
guyafor <- DBI::dbConnect(RSQLite::SQLite(), dbname = "data/guyafor.sql")
trees <- tbl(guyafor, "inventory") %>% 
  filter(Forest == "Paracou") %>% 
  # filter(Plot %in% 1:12) %>%
  collect() %>% 
  filter(Xfield > 20, Xfield < 250-20, Yfield > 20, Yfield < 250-20) %>% 
  mutate(species = paste(Genre, Espece)) %>% 
  filter(!grepl("Indet", species)) %>% 
  mutate(DBH = CircCorr/pi)
DBI::dbDisconnect(guyafor) ; rm(guyafor)
```

```{r logfig}
trees %>% 
  group_by(Plot) %>% 
  mutate(StartYear = min(CensusYear)) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  filter(first(CensusYear) > StartYear) %>% 
  filter(first(DBH) < 12) %>% 
  filter(last(DBH) > first(DBH)) %>% 
  filter(n() > 20) %>% 
  filter(idTree %in% sample(unique(.$idTree), 20)) %>%
  ggplot(aes(CensusYear, DBH, col = as.factor(idTree))) +
  geom_point(alpha = 0.1) +
  geom_smooth(se = F, alpha = 0.5) +
  scale_y_sqrt() +
  scale_color_discrete(guide = "none")
```

```{r logdata}
trees <- trees %>% 
  group_by(Plot) %>% 
  mutate(StartYear = min(CensusYear)) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  filter(first(CensusYear) > StartYear) %>% 
  filter(first(DBH) < 12) %>% 
  filter(last(DBH) > first(DBH)) %>% 
  filter(n() > 20) %>% 
  mutate(Year = CensusYear - first(CensusYear)) %>%
  mutate(DBHprev = lag(DBH)) %>% 
   mutate(Deltat = CensusYear - lag(CensusYear)) %>% 
  filter(!is.na(DBHprev)) %>% 
  ungroup() %>% 
  # filter(idTree %in% sample(unique(.$idTree), 10)) %>%
  mutate(ind = as.numeric(as.factor(as.character(idTree)))) %>% 
  mutate(sp = as.numeric(as.factor(species)))
eval <- trees %>% 
  group_by(idTree) %>% 
  filter(CensusYear == max(CensusYear))
mdata <- trees %>% 
  group_by(idTree) %>% 
  filter(CensusYear != max(CensusYear))
```

```{r logdatafig}
ggplot(mdata, aes(Year, DBH, col = as.factor(ind))) +
  geom_point() +
  geom_point(data = eval, col = "red", size = 2) +
  geom_smooth(se = F) +
  scale_color_discrete(guide = "none")
```

```{r logfit, eval=F}
beta <- normal(0, 10, dim = max(mdata$ind), truncation = c(0, Inf))
sigma <- normal(0, 10, truncation = c(0, 200))
distribution(mdata$DBH) <- normal(10+beta[mdata$ind]*log(mdata$Year), sigma)
m <- model(beta, sigma)
fit <- mcmc(m, warmup = 1000, n_samples = 1000, chains = 2)
save(mdata, fit, file = "save/log.Rdata")
```

```{r logsapling}
load("save/log.Rdata") 
```

```{r traceplotlogi1, fig.cap="Trace plot i1."}
ind <- 1
mcmc_trace(fit, pars = c(paste0("beta[", ind, ",1]"), "sigma")) 
```

```{r pairsplotlogi1, fig.cap="Pairs plot i1."}
ind <- 1
mcmc_pairs(fit, pars = c(paste0("beta[", ind, ",1]"),
                         "sigma")) 
```

```{r loggmax, fig.cap="Posteriors for individual growth potential."}
mcmc_intervals(fit, regex_pars = "beta")
```

```{r logpreds, fig.cap="Predictions for individual growth."}
preds <- as.data.frame(summary(fit)$statistics) %>% 
  dplyr::select(Mean) %>% 
  rownames_to_column("parameter") %>% 
  separate(parameter, c("parameter", "ind")) %>% 
  reshape2::dcast(ind ~ parameter, value.var = "Mean") %>% 
  dplyr::select(-sigma) %>% 
  mutate(Year = list(seq(1, max(trees$Year), length.out = 100))) %>% 
  unnest(Year) %>% 
  mutate(DBH = 10+beta*log(Year))
ggplot(mdata, aes(Year, DBH, col = as.factor(ind))) +
  geom_point() +
  geom_point(data = eval, col = "red", size = 2) +
  geom_line(data = preds) +
  scale_color_discrete(guide = "none")
```

```{r logrmsep}
rmsep <- eval %>% 
  left_join(as.data.frame(summary(fit)$statistics) %>% 
              dplyr::select(Mean) %>% 
              rownames_to_column("parameter") %>% 
              separate(parameter, c("parameter", "ind"), convert = T) %>% 
              reshape2::dcast(ind ~ parameter, value.var = "Mean") %>% 
              dplyr::select(-sigma)) %>% 
  ungroup() %>% 
  mutate(DBHpred = 10+beta*log(Year)) %>% 
  mutate(SEP = (DBH - DBHpred)^2) 
ggplot(rmsep, aes(sqrt(SEP))) +
  geom_boxplot() +
  coord_flip() +
  ggtitle(paste("RMSEP=", round(sqrt(mean(rmsep$SEP)), 2), "cm"))
```
