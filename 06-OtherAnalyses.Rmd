```{r analyses2, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(googlesheets4)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Other analyses

In this chapter, I quickly  investigated effects of functional traits and weather on individual growth.

## Methods

I used linear model for individual growth potential relation to functional traits at the individual or species level.
For each dataset, I first used a step procedure to select explanatory variables before using linear models with multiple variables.
I then plotted the individual relations between response and explanatory variables.

```{r dataan2}
growth <- vroom::vroom("save/growthhalf.tsv")
troll <- vroom::vroom("data/TROLLv3_species.txt") %>% 
  mutate(species = gsub("_", " ", s_name)) %>% 
  dplyr::rename(LMA = s_LMA, Nmass = s_Nmass, Pmass = s_Pmass, wsg = s_wsg, dbhmax = s_dbhmax, hmax = s_hmax, ah = s_ah) %>% 
  dplyr::select(species, LMA, Nmass, Pmass, wsg, dbhmax, hmax, ah) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)))
phd <- bind_rows(
  vroom::vroom("data/Measures_Symphonia - AllTraits.tsv") %>% 
    mutate(Genus = "Symphonia") %>%
    rename(Species = Morphotype) %>%
    mutate(Species = ifelse(Species == "Indet.",
                            c("globulifera", "sp.1", "sp.1")[fct_recode(Bark, "globulifera" = "G",
                                                                        "sp.1" =  "S")], Species)),
  vroom::vroom("data/Measures_Eschweilera - AllTraits.tsv") %>%
    filter(!(Plot == 14 & SubPlot == 1 & TreeFieldNum == 760))
) %>% 
  dplyr::select(idTree, SLA, LDMC, LT, LA, CC, brBT, brWD, brBD) %>% 
  left_join(dplyr::select(growth, idTree, species, gmax)) %>% 
  filter(!is.na(gmax))
hydro <- vroom::vroom("data/211124_TraitDatabase_species_means_updatedNames.csv") %>% 
  mutate(species = gsub("_", " ", spName.new)) %>% 
  dplyr::rename(LSWC = LSWC_E.per_corr_mean, RWC = RWC_E.per_corr_mean, Ptlp = ptlp_mean, d13C = d13C.per_mean, CN = C.N_mean,
                stomataD = stomata_density.mm2_mean, gmin = gmin.slope_mean, LWC = LWC_mean, LDMC = LDMC.mg.g_mean,
                N = N.per_mean, C = C.per_mean, P12stem = P12_stem.Mpa_mean, P50stem = P50_stem.MPa_mean, P88stem = P88_stem.MPa_mean,
                P12leaf = P12_leaf.MPa_mean, P50leaf = P50_leaf.MPa_mean, P88leaf = P88_leaf.MPa_mean) %>% 
  dplyr::select(species, LSWC, RWC, Ptlp, d13C, CN, stomataD, gmin, LWC, LDMC, N, C, P12stem, P50stem, P88stem, P12leaf, P50leaf, P88leaf) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)))
```

## Results

### Bridge

As highlighted by @Herault2011, wood specific gravity is a strong driver of species growth potential ($\beta=-1.98, p<0.001, R^2=0.563$), with dense tree growing logically slower.

```{r, eval=F}
troll %>% 
  na.omit() %>% 
  mutate(logLMA = log(LMA), logNmass = log(Nmass), logPmass = log(Pmass), logwsg = log(wsg),
         logdhbbmax = log(dbhmax), loghmax = log(hmax), logah = log(ah)) %>% 
  reshape2::melt(c("species", "gmax"), variable.name = "trait") %>% 
  group_by(trait) %>% 
  do(lm(log(gmax) ~ value, data = .) %>% moderndive::get_regression_table()) %>% 
  filter(term != "intercept") %>% 
  dplyr::select(-term) %>% 
  filter(p_value < 0.05)
```

```{r trolllm}
lm(log(gmax) ~ log(wsg), troll) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r trollfig}
ggplot(aes(wsg, gmax), data = troll) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Wood specific gravity (WSG, g/g)") +  ylab("Species growth potential (Gmax, cm/yr)") + 
  scale_y_log10() + scale_x_log10()
```

### ParacouITV

Interestingly, leaf dry matter content seems to drive individual growth potential within species of *Symphonia* and *Eschweilera* genera
($\beta=-0.91, p=0.016, R^2=0.083$), but the signal is weak.

```{r, eval=F}
phd %>% 
  mutate(logSLA = log(SLA), logLDMC = log(LDMC), logLT = log(LT), logLA = log(LA),
         logCC = log(CC), logbrBT = log(brBT), logbrWD = log(brWD), logbrBD = log(brBD)) %>% 
  reshape2::melt(c("species", "gmax"), variable.name = "trait") %>% 
  na.omit() %>% 
  group_by(trait) %>% 
  do(lm(gmax ~ value, data = .) %>% moderndive::get_regression_table()) %>% 
  filter(term != "intercept") %>% 
  dplyr::select(-term) %>% 
  filter(p_value < 0.05)
```

```{r phdlm}
lm(log(gmax) ~ CC + log(LA) + log(LDMC), phd) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r phdfig}
ggplot(aes(LDMC, gmax, col = species, group = NA), data = phd) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("Leaf dry matter content (LDMC, g/g)") +  ylab("Individual growth potential (Gmax, cm/yr)") + 
  scale_y_log10() + scale_x_log10()
```

### hydroParacou

Interestingly, turgor loss point and stomatal density appear to influence species growth potential with a positive effect ($\beta=1.13, p=0.004$ & $\beta=0.28, p<0.001$, $R^2=0.0312$).
Species with more stomata lose their turgidity more quickly but grow faster.

```{r, eval=F}
bind_rows(
  hydro %>% 
    reshape2::melt(c("species", "gmax"), variable.name = "trait") %>% 
    na.omit() %>% 
    group_by(trait) %>% 
    do(lm(log(gmax) ~ value, data = .) %>% moderndive::get_regression_table()) %>% 
    filter(term != "intercept") %>% 
    dplyr::select(-term) %>% 
    filter(p_value < 0.05),
  hydro %>% 
    reshape2::melt(c("species", "gmax"), variable.name = "trait") %>% 
    na.omit() %>% 
    group_by(trait) %>% 
    mutate(value = log(abs(value)), trait = paste0("log", trait)) %>% 
    do(lm(log(gmax) ~ value, data = .) %>% moderndive::get_regression_table()) %>% 
    filter(term != "intercept") %>% 
    dplyr::select(-term) %>% 
  filter(p_value < 0.05)
)
```

```{r hydrolm}
lm(log(gmax) ~ Ptlp + log(CN) + log(stomataD),
   mutate_at(hydro, c("Ptlp", "CN", "stomataD"), scale, center = F)) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r hydrofig}
hydro %>% 
  mutate(logStomataD = log(stomataD)) %>% 
  reshape2::melt(c("species", "gmax"), variable.name = "trait") %>% 
  na.omit() %>% 
  filter(trait %in% c("Ptlp", "logStomataD")) %>% 
  ggplot(aes(value, gmax)) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlab("") +  ylab("Species growth potential (Gmax, cm/yr)") + 
  scale_y_log10() + facet_wrap(~ trait, scales = "free_x")
```
