```{r analyses, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(greta)
library(ggtree)
library(phylosignal)
library(adephylo)
library(ape)
library(phylobase)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Analyses

In this chapter we ...

```{r env, eval=F}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(parallel)
library(doSNOW)
library(foreach)
library(tidyverse)
data <- vroom::vroom("save/mdatahalf.tsv") %>% 
  dplyr::select(idTree, Plot, Xutm, Yutm) %>% 
  unique()
cl <- makeCluster(4, outfile = "/dev/null")
registerDoSNOW(cl)
pb <- txtProgressBar(max = nrow(data), style = 3)
progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)
NC <- foreach(ind=1:nrow(data),
              .packages = "dplyr",
              .options.snow = opts) %dopar% {
                con <- DBI::dbConnect(RSQLite::SQLite(), dbname = "data/guyafor.sql")
                NC <- tbl(con, "inventory") %>% 
                  filter(Plot == local(data$Plot[ind])) %>% 
                  filter(idTree != local(data$idTree[ind])) %>% 
                  mutate(dij = sqrt((local(data$Xutm[ind]) - Xutm)^2+(local(data$Yutm[ind]) - Yutm)^2)) %>% 
                  filter(dij < 20) %>% 
                  mutate(DBH = CircCorr/pi) %>% 
                  collect() %>% 
                  group_by(CensusYear) %>% 
                  summarise(NCI = sum(DBH*DBH*exp(-0.25*dij))) %>% 
                  ungroup() %>% 
                  summarise(idTree = local(data$idTree[ind]),
                            NCI = mean(NCI))
                DBI::dbDisconnect(con)
                return(NC)
              } 
close(pb)
stopCluster(cl)
NC <- bind_rows(NC)
XY <- NC %>% 
  left_join(data) %>% 
  sf::st_as_sf(coords = c("Xutm", "Yutm"),
             crs = '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0')
NC$twi <- raster::extract(raster::raster("data/TWI_1m.tif"), XY)
write_tsv(NC, file = "save/env_half.tsv")
```

```{r phylo, eval=F}
library(V.PhyloMaker)
splist <- vroom::vroom("save/mdatahalf.tsv") %>% 
  dplyr::select(Family, Genus, species) %>% 
  unique() %>% 
  mutate(genus = Genus, family = Family) %>% 
  dplyr::select(species, genus, family)
tree <- phylo.maker(sp.list = splist, tree = GBOTB.extended, nodes = nodes.info.1, scenarios = "S3")
ape::write.tree(tree$scenario.3, "save/phylogeny_half.tree")
```

```{r parsan, eval=F}
load("save/growthhalf.Rdata")  
pars <- as.data.frame(fit_half, pars = c('gmax')) %>% 
  reshape2::melt(variable.name = "parameter") %>% 
  group_by(parameter) %>% 
  summarise(value = median(value)) %>% 
  separate(parameter, c("parameter", "ind"), convert = T) %>% 
  reshape2::dcast(ind ~ parameter)
rm(fit_half) ; invisible(gc())
mdata <- vroom::vroom("save/mdatahalf.tsv")
growth <- pars %>% 
  left_join(dplyr::select(mdata, ind, idTree, Family, Genus, species)) %>% 
  left_join(vroom::vroom(file = "save/env_half.tsv")) %>% 
  unique()
vroom::vroom_write(growth, file = "save/growthhalf.tsv")
```

```{r dataan}
growth <- vroom::vroom("save/growthhalf.tsv")
phylo <- ape::read.tree("save/phylogeny_half.tree")
p4d <- phylo4d(phylo,
               data.frame(species = gsub("_", " ", phylo$tip.label)) %>% 
                 left_join(group_by(growth, species) %>% summarise(gmax  = mean(log(gmax), na.rm = T))) %>% 
                 dplyr::select(-species))
# p4d <- subset(p4d, tips.exclude=c("Siparuna_cuspidata"))
```

```{r lm}
lme4::lmer(log(gmax) ~ log(NCI) + log(twi+1) + (1  | Family/Genus/species), growth) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r r2, eval=F }
m <- lme4::lmer(log(gmax) ~ log(NCI) + log(twi+1) + (1  | Family/Genus/species), 
                na.omit(dplyr::select(growth, Family, Genus, species, NCI, twi, gmax)) %>% mutate(twi = ifelse(twi <= 0, 10^-6, twi)))
r2 <- partR2::partR2(m, partvars = c("log(NCI)", "log(twi+1)"), R2_type = "marginal", nboot = 10)
partR2::forestplot(r2, type = "R2", text_size = 10)
```

```{r gmaxnci, fig.cap="Relation between Neighbourhood crowding index (NCI) and individual growth potential (Gmax, cm/yr)."}
ggplot(growth, aes(NCI, gmax, col = species)) +
  geom_point() +
  geom_smooth(method = "lm", aes(group = NA)) +
  scale_color_discrete(guide = "none") +
  scale_x_log10() + scale_y_log10() +
  xlab("Neighbourhood crowding index (NCI)") +
  ylab("Individual growth potential (Gmax, cm/yr)")
```

```{r gmaxphylo, fig.cap="Distribution of species growth potential (Gmax, cm/yr) in the phylogeny."}
fortify(phylo) %>% 
  mutate(species = gsub("_", " ", label)) %>%
  mutate(label = species) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax = mean(gmax))) %>% 
  ggtree(aes(color = log(gmax)), layout="circular") + 
  geom_tiplab2(size = 2) +
  theme_tree(legend.position='right', legend.text = element_text(face = "italic")) +
  scale_alpha_manual("taxon", values = c(0.2, 1)) +
  scale_size_manual("taxon", values = c(1, 2)) +
  viridis::scale_color_viridis(expression(log(gmax)))
```

```{r gmaxphylosignal}
phyloSignal(p4d = p4d, method = "all") %>% 
  lapply(as.data.frame) %>% 
  lapply(rownames_to_column, "parameter") %>% 
  bind_rows(.id = "type") %>% 
  reshape2::melt(c("type", "parameter")) %>% 
  reshape2::dcast(parameter + variable ~ type) %>% 
  kable(caption = "Phylogenetic signal of species growth potential (Gmax, cm/yr) with different methods.")
```

```{r gmaxcorrelog, fig.cap="phylogenetic correlogram of species growth potential (Gmax, cm/yr)."}
# crlg <- phyloCorrelogram(p4d, trait = "gmax", ci.bs	= 100)
# png(file = "save/figs/gmaxcorrelog.png", width = 1000, height = 1000, units = "px")
# plot(crlg, main="phylogenetic correlogram")
# dev.off()
include_graphics("save/figs/gmaxcorrelog.png")
```

```{r lipa, fig.cap="Local phylogenetic associations of of species growth potential (Gmax, cm/yr) among taxa in the phylogeny."}
fortify(phylo) %>% 
  mutate(species = gsub("_", " ", label)) %>%
  mutate(label = species) %>% 
  left_join(lipaMoran(p4d)$p.value %>% 
              as.data.frame() %>% 
              rownames_to_column("species") %>% 
              mutate(species = gsub("_", " ", species)) %>% 
              dplyr::rename(pval = gmax)) %>% 
  ggtree(aes(color = pval < 0.5), layout="circular") + 
  geom_tiplab2(size = 2) +
  theme_tree(legend.position='right', legend.text = element_text(face = "italic")) +
  scale_alpha_manual("taxon", values = c(0.2, 1)) +
  scale_size_manual("taxon", values = c(1, 2)) +
  scale_color_manual("Local\nIndicator\nof\nPhylogenetic\nAssociation\np<0.05", values =  c("grey", "red", "grey"))
```
