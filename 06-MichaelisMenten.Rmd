```{r mm, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(greta)
library(ggtree)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Michaelis Menten

Using time $t$ since recruitment (DBH=10cm) for each individual tree $i$:

$$DBH_{i,t} \sim \mathcal N (10 + \frac{\alpha_i \times t}{\beta_i+t}, \sigma)$$

```{r mmdata}
guyafor <- DBI::dbConnect(RSQLite::SQLite(), dbname = "data/guyafor.sql")
trees <- tbl(guyafor, "inventory") %>% 
  filter(Forest == "Paracou") %>% 
  # filter(Plot %in% 1:12) %>%
  collect() %>% 
  filter(Xfield > 20, Xfield < 250-20, Yfield > 20, Yfield < 250-20) %>% 
  mutate(species = paste(Genre, Espece)) %>% 
  filter(!grepl("Indet", species)) %>% 
  mutate(DBH = CircCorr/pi)
DBI::dbDisconnect(guyafor) ; rm(guyafor)
```

```{r mmfig}
trees %>% 
  group_by(Plot) %>% 
  mutate(StartYear = min(CensusYear)) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  filter(first(CensusYear) > StartYear) %>% 
  filter(first(DBH) < 12) %>% 
  filter(last(DBH) > first(DBH)) %>% 
  filter(n() > 20) %>% 
  filter(idTree %in% sample(unique(.$idTree), 20)) %>%
  ggplot(aes(CensusYear, DBH, col = as.factor(idTree))) +
  geom_point(alpha = 0.1) +
  geom_smooth(se = F, alpha = 0.5) +
  scale_y_sqrt() +
  scale_color_discrete(guide = "none")
```

```{r mmmdata}
trees <- trees %>% 
  group_by(Plot) %>% 
  mutate(StartYear = min(CensusYear)) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  filter(first(CensusYear) > StartYear) %>% 
  filter(first(DBH) < 12) %>% 
  filter(last(DBH) > first(DBH)) %>% 
  filter(n() > 20) %>% 
  mutate(Year = CensusYear - first(CensusYear)) %>%
  ungroup() %>% 
  # filter(idTree %in% sample(unique(.$idTree), 10)) %>%
  mutate(ind = as.numeric(as.factor(as.character(idTree))))
eval <- trees %>% 
  group_by(idTree) %>% 
  filter(CensusYear == max(CensusYear))
mdata <- trees %>% 
  group_by(idTree) %>% 
  filter(CensusYear != max(CensusYear))
```

```{r mmmdatafig}
ggplot(mdata, aes(Year, DBH, col = as.factor(ind))) +
  geom_point() +
  geom_point(data = eval, col = "red", size = 2) +
  geom_smooth(se = F) +
  scale_color_discrete(guide = "none")
```

```{r mmfit, eval=F}
alpha <- normal(0, 10, dim = max(mdata$ind), truncation = c(0, 200))
beta <- normal(0, 10, dim = max(mdata$ind), truncation = c(0, Inf))
sigma <- normal(0, 10, truncation = c(0, 200))
distribution(mdata$DBH) <- normal(10 + alpha[mdata$ind]*mdata$Year/(beta[mdata$ind]+mdata$Year), sigma)
m <- model(alpha, beta, sigma)
fit <- mcmc(m, warmup = 1000, n_samples = 1000, chains = 2)
save(mdata, fit, file = "save/mm.Rdata")
```

```{r mmsapling}
load("save/mm.Rdata") 
```

```{r traceplotmmi1, fig.cap="Trace plot i1."}
ind <- 1
mcmc_trace(fit, pars = c(paste0("alpha[", ind, ",1]"), 
                         paste0("beta[", ind, ",1]"),
                         "sigma")) 
```

```{r pairsplotmmi1, fig.cap="Pairs plot i1."}
ind <- 1
mcmc_pairs(fit, pars = c(paste0("alpha[", ind, ",1]"), 
                         paste0("beta[", ind, ",1]"),
                         "sigma")) 
```

```{r mmrhat, fig.cap="Rhat distribution.", eval=F}
data.frame(Rhat = coda::gelman.diag(fit)$psrf[,1], par = names(coda::gelman.diag(fit)$psrf[,1])) %>% 
  ggplot(aes(Rhat)) +
  geom_histogram()
```

```{r mmalpha, fig.cap="Posteriors for individual plateau."}
mcmc_intervals(fit, regex_pars = "alpha")
```

```{r mmbeta, fig.cap="Posteriors for individual slope."}
mcmc_intervals(fit, regex_pars = "beta")
```

```{r mmpreds, fig.cap="Predictions for individual growth."}
preds <- as.data.frame(summary(fit)$statistics) %>% 
  dplyr::select(Mean) %>% 
  rownames_to_column("parameter") %>% 
  separate(parameter, c("parameter", "ind")) %>% 
  reshape2::dcast(ind ~ parameter, value.var = "Mean") %>% 
  dplyr::select(-sigma) %>% 
  mutate(Year = list(seq(0, max(trees$Year), length.out = 100))) %>% 
  unnest(Year) %>% 
  mutate(DBH = 10+alpha*Year/(beta+Year))
ggplot(mdata, aes(Year, DBH, col = as.factor(ind))) +
  geom_point() +
  geom_point(data = eval, col = "red", size = 2) +
  geom_line(data = preds) +
  scale_color_discrete(guide = "none")
```

```{r mmrmsep}
rmsep <- eval %>% 
  left_join(as.data.frame(summary(fit)$statistics) %>% 
              dplyr::select(Mean) %>% 
              rownames_to_column("parameter") %>% 
              separate(parameter, c("parameter", "ind"), convert = T) %>% 
              reshape2::dcast(ind ~ parameter, value.var = "Mean") %>% 
              dplyr::select(-sigma)) %>% 
  ungroup() %>% 
  mutate(DBHpred = 10+alpha*Year/(beta+Year)) %>% 
  mutate(SEP = (DBH - DBHpred)^2) 
ggplot(rmsep, aes(sqrt(SEP))) +
  geom_boxplot() +
  coord_flip() +
  ggtitle(paste("RMSEP=", round(sqrt(mean(rmsep$SEP)), 2), "cm"))
```

```{r mmgrowthdata}
growth <- as.data.frame(summary(fit)$statistics) %>% 
  dplyr::select(Mean) %>% 
  rownames_to_column("parameter") %>% 
  separate(parameter, c("parameter", "ind"), convert = T) %>% 
  reshape2::dcast(ind ~ parameter, value.var = "Mean") %>% 
  left_join(dplyr::select(mdata, ind, idTree, Family, Genus, species)) %>% 
  left_join(read_tsv(file = "save/env_full.tsv"))
phylo <- ape::read.tree("save/phylogeny_full.tree")
```

```{r mmalphalmmm}
lme4::lmer(log(alpha) ~ log(NCI) + (1  | Family/Genus/species), growth) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r mmalphanci}
ggplot(growth, aes(log(NCI), log(alpha), col = species)) +
  geom_point() +
  geom_smooth(method = "lm", aes(group = NA)) +
  scale_color_discrete(guide = "none")
```

```{r mmalphaphylo}
fortify(phylo) %>% 
  mutate(species = gsub("_", " ", label)) %>%
  mutate(label = species) %>% 
  left_join(group_by(growth, species) %>% summarise(alpha = mean(alpha))) %>% 
  ggtree(aes(color = log(alpha)), layout="circular") + 
  geom_tiplab2(size = 2) +
  theme_tree(legend.position='right', legend.text = element_text(face = "italic")) +
  scale_alpha_manual("taxon", values = c(0.2, 1)) +
  scale_size_manual("taxon", values = c(1, 2)) +
  viridis::scale_color_viridis(expression(beta))
```

```{r }
lme4::lmer(log(beta) ~ log(NCI) + (1  | Family/Genus/species), growth) %>% 
  sjPlot::tab_model(show.icc = F)
```

```{r }
ggplot(growth, aes(log(NCI), log(beta), col = species)) +
  geom_point() +
  geom_smooth(method = "lm", aes(group = NA)) +
  scale_color_discrete(guide = "none")
```

```{r }
fortify(phylo) %>% 
  mutate(species = gsub("_", " ", label)) %>%
  mutate(label = species) %>% 
  left_join(group_by(growth, species) %>% summarise(beta = mean(beta))) %>% 
  ggtree(aes(color = beta), layout="circular") + 
  geom_tiplab2(size = 2) +
  theme_tree(legend.position='right', legend.text = element_text(face = "italic")) +
  scale_alpha_manual("taxon", values = c(0.2, 1)) +
  scale_size_manual("taxon", values = c(1, 2)) +
  viridis::scale_color_viridis(expression(beta))
```
