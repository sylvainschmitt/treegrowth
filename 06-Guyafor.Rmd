```{r guyafor, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(cmdstanr)
library(ggtree)
library(phylosignal)
library(adephylo)
library(ape)
library(phylobase)
theme_set(bayesplot::theme_default())
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Guyafor

In this chapter, I repeated the model fit for the whole Guyafor network.

## Data

I used only recruited trees in the censuses with at least 4 measurements of diameter at breast height (DBH, cm).
I used only species with at least 4 trees following previous requirements (Tab. \@ref(tab:guyafortab) & Fig. \@ref(fig:mdataguyaforfig)).

```{r guyaforlim}
n_ind_species <- 4
n_years <- 10
n_census <- 4
```

```{r guyaforfull, eval=F}
trees <- vroom::vroom("data/Selection_Guyafor_Gmax_4_4.csv", locale=locale(decimal_mark=',')) %>% 
  mutate(species = paste(Genus, Species)) %>% 
  filter(!grepl("Indet", species)) %>% 
  filter(BotaSource == "Bota") %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  mutate(FirstDead = first(CensusYear[CodeAlive == 0])) %>% 
  mutate(FirstDead = ifelse(is.na(FirstDead), max(CensusYear)+1, FirstDead)) %>% 
  filter(CensusYear < FirstDead) %>% 
  ungroup() %>% 
  mutate(DBH = CircCorr/pi) %>%
  group_by(Plot) %>% 
  mutate(StartYear = min(CensusYear)) %>% 
  group_by(idTree) %>% 
  arrange(CensusYear) %>% 
  filter(first(CensusYear) > StartYear) %>% 
  filter(first(DBH) < 15) %>%
  filter(last(DBH) > first(DBH)) %>% 
  group_by(idTree) %>% 
  filter(max(CensusYear) - min(CensusYear) >= n_years) %>% 
  filter(n() >= n_census) %>% 
  group_by(species) %>% 
  filter(length(unique(idTree)) >= n_ind_species)
rm(n_census, n_ind_species)
vroom::vroom_write(trees, "save/trees_guyafor.tsv")
```

```{r  guyafortab}
options(knitr.kable.NA = '')
vroom::vroom("save/trees_guyafor.tsv") %>% 
  group_by(Family, Genus, species, idTree) %>% 
  summarise(census = n(), year_start = min(CensusYear), year_end = max(CensusYear),
            dbh_start = min(DBH), dbh_end = max(DBH)) %>% 
  ungroup() %>% 
  summarise(n_families = length(unique(Family)),
            n_genera = length(unique(Genus)),
            n_species = length(unique(species)),
            n_individuals = length(unique(idTree)),
            n_observations = nrow(vroom::vroom("save/trees_guyafor.tsv")),
            min_census = min(census),
            med_census = median(census),
            max_census = max(census),
            min_year0 = min(year_start),
            med_year0 = median(year_start),
            max_year0 = max(year_start),
            min_yearmax = min(year_end),
            med_yearmax = median(year_end),
            max_yearmax = max(year_end),
            min_dbh0 = min(dbh_start),
            med_dbh0 = median(dbh_start),
            max_dbh0 = max(dbh_start),
            min_dbhmax = min(dbh_end),
            med_dbhmax = median(dbh_end),
            max_dbhmax = max(dbh_end)) %>% 
  reshape2::melt() %>% 
  separate(variable, c("measure", "variable")) %>% 
  reshape2::dcast(variable ~ measure) %>% 
  dplyr::select(variable, n, med, min, max) %>% 
  mutate(variable = factor(variable, levels = c("families", "genera", "species", "individuals", "observations",
                                                "census", "year0", "yearmax", "dbh0", "dbhmax"))) %>% 
  arrange(variable) %>% 
  kable(col.names = c("", "N", "Median", "Minimum", "Maximum"), format.args = list(big.mark = " "), digits = 0,
        caption = "Metrics on inventory data used to fit the full model including sample size (N), memdian, minimum and maximum values for families, genera, species, individuals, observations, cenusus, recruitment year (year0), last censused year (yearmax), recruitment diameter (dbh0) and last censused diameter (dbhmax).")    
```


```{r mdataguyafor, eval=F}
vroom::vroom("save/trees_guyafor.tsv") %>% 
  group_by(idTree) %>% 
  mutate(Year = CensusYear - min(CensusYear)) %>%
  ungroup() %>% 
  mutate(ind = as.numeric(as.factor(as.character(idTree)))) %>% 
  mutate(sp = as.numeric(as.factor(species))) %>% 
  vroom::vroom_write("save/mdataguyafor.tsv")
```

```{r mdataguyaforfig, fig.cap="Tree diameter trajectories in reduced data. Color represent individuals."}
dplyr::select(vroom::vroom("save/mdataguyafor.tsv"), sp, ind) %>% 
  unique() %>% 
  filter(sp %in% sample(unique(.$sp), 9)) %>% 
  group_by(sp) %>% 
  sample_n(5, replace = T) %>%
  unique() %>% 
  left_join(vroom::vroom("save/mdataguyafor.tsv")) %>% 
  ggplot(aes(Year, DBH, group = as.factor(ind))) +
  geom_point(col = "grey") +
  geom_smooth(se = F, aes(col = as.factor(ind))) +
  xlim(0,NA) +
  facet_wrap(~ species, scales = "free") +
  scale_color_discrete(guide = "none")  
```

## Model

I used a Gompertz model [@Herault2011], were the diameter of individual $i$ at year $t$ is the sum of annual growth from $t0$ to $t$:

$$  DBH_{t,i,s} \sim \mathcal N  (10 + Gmax_i \times \sum _{y=1|DBH_{t=0}} ^{y=t} exp(-\frac12.[\frac{log(\frac{DBH_{t,i}}{100.Dopt_i})}{Ks_i}]^2)), \sigma) \\| Dopt_i \sim \mathcal N(Dopt_s,\sigma_D), Ks_i \sim \mathcal N(Ks_s,\sigma_K) $$

The annual growth rate for individual $i$ at year $y$ with a diameter of $DBH_{y,i}$ is defined following a Gompertz model [@Gompertz1825] already identified as the best model for growth-trajectories in Paracou [@Herault2011],
where $Gmax_i$ is the fixed maximum growth potential of every individual,
$Dopt_i$ is the optimal diameter at which the individual reaches its maximum growth potential,
and $Ks_i$ is the kurtosis defining the width of the bell-shaped growth-trajectory [see figure 1 in @Herault2011].
$Dopt_i$ and $Ks_i$ are random effects centered on species parameters $Dopt_s$ and $Ks_s$ with associated variances $\sigma_D$ and $\sigma_K$.

```{r growthguyaforfit, eval=F}
mdata <- vroom::vroom("save/mdataguyafor.tsv")
growth <- cmdstan_model("model/growth.stan")
fit <- growth$sample(
  data = list(
    N = nrow(filter(mdata, Year > 0)),
    I = max(mdata$ind),
    S = max(mdata$sp),
    Y = max(mdata$Year),
    year = filter(mdata, Year > 0)$Year,
    dbh = filter(mdata, Year > 0)$DBH,
    dbh0 = filter(mdata, Year == 0)$DBH,
    dmax = summarise(group_by(mdata, sp), dmax = max(DBH))$dmax,
    ind = filter(mdata, Year > 0)$ind,
    indsp = arrange(unique(mdata[c("ind", "sp")]), ind)$sp
  ),
  chains = 4, 
  parallel_chains = 4,
  refresh = 10,
  save_warmup = F,
  max_treedepth = 12
)
fit$save_output_files(dir = "save/growthguyafor")
```


```{r, eval=F, echo=T}
fit <- read_cmdstan_csv("save/growthguyafor/growth-202210280057-1-361cf6.csv")
draws <- drop(fit$post_warmup_draws) %>% 
  as_data_frame() %>% 
  mutate(iteration = 1:n()) %>% 
  gather(parameter, value, -iteration)
vroom::vroom_write(draws, file = 'save/growthguyafor/chain1.tsv')
rm(fit, draws)
gc()
```

```{r, eval=F, echo=T}
fit <- read_cmdstan_csv("save/growthguyafor/growth-202210280057-2-361cf6.csv")
draws <- drop(fit$post_warmup_draws) %>% 
  as_data_frame() %>% 
  mutate(iteration = 1:n()) %>% 
  gather(parameter, value, -iteration)
vroom::vroom_write(draws, file = 'save/growthguyafor/chain2.tsv')
rm(fit, draws)
gc()
```

```{r, eval=F, echo=T}
fit <- read_cmdstan_csv("save/growthguyafor/growth-202210280057-3-361cf6.csv")
draws <- drop(fit$post_warmup_draws) %>% 
  as_data_frame() %>% 
  mutate(iteration = 1:n()) %>% 
  gather(parameter, value, -iteration)
vroom::vroom_write(draws, file = 'save/growthguyafor/chain3.tsv')
rm(fit, draws)
gc()
```

```{r, eval=F, echo=T}
fit <- read_cmdstan_csv("save/growthguyafor/growth-202210280057-4-361cf6.csv")
draws <- drop(fit$post_warmup_draws) %>% 
  as_data_frame() %>% 
  mutate(iteration = 1:n()) %>% 
  gather(parameter, value, -iteration)
vroom::vroom_write(draws, file = 'save/growthguyafor/chain4.tsv')
rm(fit, draws)
gc()
```

```{bash, eval=F, echo=T}
grep gmax chain1.tsv > gmax1.tsv
grep gmax chain2.tsv > gmax2.tsv
grep gmax chain3.tsv > gmax3.tsv
grep gmax chain4.tsv > gmax4.tsv
```

```{r, eval=F, echo=T}
bind_rows(
  vroom::vroom('save/growthguyafor/gmax1.tsv', col_names = c("iteration", "parameter", "value")) %>%
  mutate(chain = 1),
  vroom::vroom('save/growthguyafor/gmax2.tsv', col_names = c("iteration", "parameter", "value")) %>%
  mutate(chain = 2),
  vroom::vroom('save/growthguyafor/gmax3.tsv', col_names = c("iteration", "parameter", "value")) %>%
  mutate(chain = 3),
  vroom::vroom('save/growthguyafor/gmax4.tsv', col_names = c("iteration", "parameter", "value")) %>%
  mutate(chain = 4)
) %>% 
  separate(parameter, c("gmax", "ind")) %>% 
  vroom::vroom_write(file = 'save/growthguyafor/gmax.tsv')
```

```{r, eval=F, echo=T}
library(csv2sql)
gmax <- vroom::vroom(file = 'save/growthguyafor/gmax.tsv')
write_csv(gmax, file = 'save/growthguyafor/gmax.csv')
csv_to_sqlite(csv_name = 'save/growthguyafor/gmax.csv', 
              db_name = 'save/growthguyafor/gmax.sql', 
              table_name = "gmax")
unlink('save/growthguyafor/gmax.csv')
```

```{r draws, eval=F}
rm(list = ls()) ; gc()
library(foreach)
I <- max(vroom::vroom("save/mdataguyafor.tsv")$ind)
cl <- parallel::makeCluster(10, outfile = "")
doSNOW::registerDoSNOW(cl)
pb <- utils::txtProgressBar(max = I, style = 3)
progress <- function(n) utils::setTxtProgressBar(pb, n)
opts <- list(progress = progress)
gmax <- foreach(i=1:I, .options.snow = opts) %dopar% {
  suppressMessages(library(dplyr))
  gmaxdb <- DBI::dbConnect(RSQLite::SQLite(), 
                           dbname = "save/growthguyafor/gmax.sql")
  gmax <- tbl(gmaxdb, "gmax") %>% 
    filter(ind == i) %>% 
    collect() %>% 
    summarise(q5 = quantile(value, 0.05), q25 = quantile(value, 0.25), 
              median= quantile(value, 0.5), 
              q75 = quantile(value, 0.75), q95 = quantile(value, 0.95))
  DBI::dbDisconnect(gmaxdb) ; rm(gmaxdb)
  gmax
}
parallel::stopCluster(cl) ; rm(cl)
save(gmax, file = "gmax.Rdata")
names(gmax) <- 1:I 
gmax_df <- bind_rows(gmax, .id = "ind")
write_tsv(gmax_df, file = "save/growthguyafor/gmax_sum.tsv")
```

## Fit

```{r growthguyaforgmaxtrace, eval=F}
gmax <- DBI::dbConnect(RSQLite::SQLite(), dbname = "save/growthguyafor/gmax.sql")
t <- tbl(gmax, "gmax") %>% 
  filter(ind %in% 1:4) %>% 
  collect()
DBI::dbDisconnect(gmax) ; rm(gmax)
t %>% 
  ggplot(aes(iteration, value, col = as.factor(chain))) +
  geom_line() +
  facet_wrap(~ ind, scales = "free_y")
```

```{r growthguyaforgmax}
gmax <- DBI::dbConnect(RSQLite::SQLite(), dbname = "save/growthguyafor/gmax.sql")
t <- tbl(gmax, "gmax") %>% 
  filter(ind %in% 1:100) %>% 
  collect() %>% 
  group_by(ind) %>% 
  summarise(ll = quantile(value, 0.05), l = quantile(value, 0.25), 
            m = quantile(value, 0.5), 
            h = quantile(value, 0.75), hh = quantile(value, 0.95))
DBI::dbDisconnect(gmax) ; rm(gmax)
ggplot(t, aes(x = ind, xend = ind)) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  coord_flip() +
  xlab("First 100 individuals") +
  ylab("gmax") +
  scale_y_log10()
```

## Evolutionary analyses

```{r parsanc, eval=F}
draws <- vroom::vroom('save/growthguyafor/gmax_sum.tsv')
inds <- vroom::vroom("save/mdataguyafor.tsv") %>% 
              group_by(Forest, Plot, SubPlot, TreeFieldNum, idTree, Xfield, Yfield, Xutm, Yutm, Lat, Lon, Family, Genus, Species, ind) %>% 
                summarise(FirstCensus = min(CensusYear), LastCensus = max(CensusYear), NCensuses = n(),
                          FirstDBH = min(DBH), LastDBH = max(DBH))
gmax <- left_join(inds, draws) %>% 
  select(-ind)
vroom::vroom_write(gmax, 'save/growthguyafor/growthguyafor.tsv') 
```

```{r phyloc, eval=F}
library(V.PhyloMaker)
splist <- vroom::vroom("save/mdataguyafor.tsv") %>% 
  dplyr::select(Family, Genus, species) %>% 
  unique() %>% 
  mutate(genus = Genus, family = Family) %>% 
  dplyr::select(species, genus, family)
tree <- phylo.maker(sp.list = splist, tree = GBOTB.extended, nodes = nodes.info.1, scenarios = "S3")
ape::write.tree(tree$scenario.3, "save/growthguyafor/phylogeny_guyafor.tree")
```

```{r dataanc}
growth <- vroom::vroom("save/growthguyafor/growthguyafor.tsv") %>% 
  mutate(species = paste(Genus, Species))
phylo <- ape::read.tree("save/growthguyafor/phylogeny_guyafor.tree")
p4d <- phylo4d(phylo,
               data.frame(species = gsub("_", " ", phylo$tip.label)) %>% 
                 left_join(
                   growth %>% 
                     group_by(species) %>% 
                     summarise(gmax = median(median), loggmax = log(gmax))
                 ) %>% 
                 dplyr::select(-species))   
```

```{r figvarc}
nlme::lme(log(median) ~  1, random=~1|Family/Genus/species, growth) %>% 
  ape::varcomp(scale = F, cum = F) %>% 
  as.vector() %>% 
  data.frame(level = c("Family", "Genus", "Species", "Individual"), variance = as.vector(.)) %>% 
  select(-`.`) %>% 
  mutate(pct = variance / sum(variance)*100) %>% 
  mutate(level = factor(level, levels = c("Family", "Genus", "Species", "Individual"))) %>% 
  mutate(pct_text = paste0(round(pct), "%")) %>% 
  mutate(pct_text = gsub("^0%", "", pct_text)) %>% 
  ggplot(aes(x = 1, y = variance, fill = level)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(y = variance, label = pct_text), col = "white", position = position_stack(vjust = .5)) +
  scale_fill_discrete(expression(sigma^2)) +
  theme(axis.title = element_blank(), axis.line = element_blank(), axis.text = element_blank(), 
        axis.ticks = element_blank(), legend.position = "bottom")+
  coord_flip() +
  scale_y_reverse()
```

```{r gmaxphyloc, fig.cap="Distribution of species growth potential (Gmax, cm/yr) in the phylogeny."}
g <- fortify(phylo) %>% 
   mutate(species = gsub("_", " ", label)) %>%
   mutate(label = species) %>% 
   left_join(group_by(growth, species) %>% summarise(gmax = median(median))) %>% 
   ggtree(aes(color = gmax), layout="circular") + 
   geom_tiplab2(size = 2) +
   theme_tree(legend.position='right', legend.text = element_text(face = "italic")) +
   scale_alpha_manual("taxon", values = c(0.2, 1)) +
   scale_size_manual("taxon", values = c(1, 2)) +
   viridis::scale_color_viridis(expression(Median(Gmax[i])~cm.year^-1), trans = "log", labels=scales::comma) +
   theme(legend.position = "bottom")
ggsave(g, filename = "save/figs/phylogenyguyafor.png", dpi = 500, width = 25, height = 25, units = "cm", bg = 'white')
include_graphics("save/figs/phylogenyguyafor.png")
```

## Functional analyses

```{r dataan2c}
rm(list = ls()) ; invisible(gc())
growth <- vroom::vroom('save/growthguyafor/growthguyafor.tsv') %>% 
  mutate(species = paste(Genus, Species)) %>% 
  mutate(gmax = median)
phd <- bind_rows(
  vroom::vroom("data/Measures_Symphonia - AllTraits.tsv") %>% 
    mutate(Genus = "Symphonia") %>%
    rename(Species = Morphotype) %>%
    mutate(Species = ifelse(Species == "Indet.",
                            c("globulifera", "sp.1", "sp.1")[fct_recode(Bark, "globulifera" = "G",
                                                                        "sp.1" =  "S")], Species)),
  vroom::vroom("data/Measures_Eschweilera - AllTraits.tsv") %>%
    filter(!(Plot == 14 & SubPlot == 1 & TreeFieldNum == 760))
) %>% 
  dplyr::select(idTree, SLA, LDMC, LT, LA, CC, brBT, brWD, brBD) %>% 
  left_join(dplyr::select(growth, idTree, species, gmax)) %>% 
  filter(!is.na(gmax)) %>% 
  group_by(species, idTree) %>% 
  summarise_all(mean, na.rm =T)
hydro <- vroom::vroom("data/211124_TraitDatabase_species_means_updatedNames.csv") %>% 
  mutate(species = gsub("_", " ", spName.new)) %>% 
  dplyr::rename(LSWC = LSWC_E.per_corr_mean, RWC = RWC_E.per_corr_mean, Ptlp = ptlp_mean, d13C = d13C.per_mean, CN = C.N_mean,
                stomataD = stomata_density.mm2_mean, gmin = gmin.slope_mean, LWC = LWC_mean, LDMC = LDMC.mg.g_mean,
                N = N.per_mean, C = C.per_mean, P12stem = P12_stem.Mpa_mean, P50stem = P50_stem.MPa_mean, P88stem = P88_stem.MPa_mean,
                P12leaf = P12_leaf.MPa_mean, P50leaf = P50_leaf.MPa_mean, P88leaf = P88_leaf.MPa_mean) %>% 
  dplyr::select(species, LSWC, RWC, Ptlp, d13C, CN, stomataD, gmin, LWC, LDMC, N, C, P12stem, P50stem, P88stem, P12leaf, P50leaf, P88leaf) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)))
fg <- readxl::read_xlsx("data/Appendix_S2-6___S8-13.xlsx", "App.S6-ok", skip = 3) %>% 
  mutate(species = gsub("_", " ", Species)) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T))) %>% 
  filter(!is.na(gmax)) %>% 
  dplyr::select(species, gmax, Chlorophyll_content, Thickness, Toughness, Leaf_Area, SLA, C, N, `13C`, Ca, P, K, 
                Trunk_bark_thickness, Sapwood_WSG, WSG, Diameter, SRL, Tissue_density, SRTA, branchiness)
cam <- read_tsv("data/Ziegler2019 - All.tsv") %>% 
  dplyr::select(-Code) %>% 
  reshape2::melt("Species", variable.name = "Trait") %>% 
  mutate(value = gsub("− ", "-", value)) %>% 
  separate(value, c("mean", "sd"), "±", convert = T) %>% 
  mutate(mean = as.numeric(mean)) %>% 
  reshape2::dcast(Species ~ Trait, value.var = "mean") %>% 
  separate(Species, c("Genus", "Species", "Author")) %>% 
  select(-Author) %>% 
  mutate(species = paste(Genus, Species)) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)) %>% separate(species, c("Genus", "Species")))
santi <- read_delim("data/Santiago2018_S1.tsv", delim = " ", skip = 1,
           col_names = c("Genus", "Species", "WD", "X1", "X2",
                         "sapwood_saturated_water_content", "X3", "X4",
                         "sapwood_osmotic_potential_at_full_turgor", "X5", "X6",
                         "sapwood_water_potential_at_turgor_loss_point", "X7", "X8",
                         "total_sapwood_bulk_elastic_modulus", "X9", "X10",
                         "total_sapwood_relative_water_content_at_turgor_loss_point", "X11", "X12",
                         "sapwood_capacitance_at_full_turgor", "X13", "X14")) %>% 
  select(Genus, Species, sapwood_saturated_water_content, sapwood_osmotic_potential_at_full_turgor,
         sapwood_water_potential_at_turgor_loss_point, total_sapwood_bulk_elastic_modulus,
         total_sapwood_relative_water_content_at_turgor_loss_point, sapwood_capacitance_at_full_turgor) %>% 
  left_join(read_delim("data/Santiago2018_S2.tsv", delim = " ", skip = 1,
                       col_names = c("Genus", "Species", "WD", "X1", "X2",
                                     "P50", "X3", "X4",
                                     "slope_P50", "X5", "X6")) %>% 
              select(Genus, Species, P50, slope_P50)) %>% 
  mutate(Genus = recode(Genus, "B." = "Bocoa", "D." = "Dicorynia", "E." = "Eperua",
                        "J." = "Jacaranda", "L." = "Licania", "P." = "Pradosia", "S." = "Sextonia",
                        "T." = "Tachigali", "V." = "Vouacapoua")) %>% 
  mutate(Genus = ifelse(Species == "globulifera", "Symphonia", Genus)) %>% 
  mutate(Genus = ifelse(Species == "sagotiana", "Eschweilera", Genus)) %>% 
  mutate(Genus = ifelse(Species == "persistens", "Lecythis", Genus)) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)) %>% separate(species, c("Genus", "Species"))) %>% 
  filter(!is.na(gmax)) 
isa <- read_tsv("data/fec12452-sup-0002-appendixs1.csv") %>% 
  dplyr::select(Binomial, Pi_tlp) %>% 
  group_by(Binomial) %>% 
  summarise(Pi_tlp = mean(Pi_tlp)) %>% 
  separate(Binomial, c("Genus", "Species")) %>% 
  left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T)) %>% separate(species, c("Genus", "Species"))) %>% 
  filter(!is.na(gmax)) 
isa2 <- read_tsv("data/fec12452-sup-0002-appendixs1.csv") %>% 
  separate(Binomial, c("Genus", "Species")) %>% 
  group_by(Genus) %>% 
  summarise(Pi_tlp = mean(Pi_tlp)) %>% 
  left_join(separate(growth, species, c("Genus", "Species"))  %>% group_by(Genus) %>% summarise(gmax  = median(gmax, na.rm = T))) %>% 
  filter(!is.na(gmax)) 
guillemot <- read_tsv("data/TAB_FINAL_GUILLEMOTetal.csv") %>% 
 left_join(group_by(growth, species) %>% summarise(gmax  = median(gmax, na.rm = T))) %>% 
    filter(!is.na(gmax))  
```

```{r }
all_data <- bind_rows(
  phd %>% 
    mutate(dataset = "Schmitt et al., (2020)", response = "Gmax_i", response_value = gmax) %>% 
    dplyr::select(dataset, species, response, response_value, SLA, LDMC, LT, LA, CC) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value"),
  fg %>% 
    mutate(dataset = "Vleminckx et al., (2021)", response = "Gmax_s", response_value = gmax) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value"),
  cam %>% 
    mutate(dataset = "Ziegler et al., (2019)", response = "Gmax_s", response_value = gmax) %>% 
    dplyr::select(-Species, -Genus) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value"),
  santi %>% 
    mutate(dataset = "Santiago et al., (2018)", response = "Gmax_s", response_value = gmax, species = paste(Species, Genus)) %>% 
    dplyr::select(-Species, -Genus) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value"),
  isa %>% 
    mutate(dataset = "Maréchaux et al., (2015)", response = "Gmax_s", response_value = gmax, species = paste(Species, Genus)) %>% 
    dplyr::select(-Species, -Genus) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value"),
  guillemot %>% 
    mutate(dataset = "Guillemot et al., (2022)", response = "Gmax_s", response_value = gmax) %>% 
    dplyr::select(-genus, -family, -leaf_habit) %>% 
    reshape2::melt(c("dataset", "species", "response", "response_value"), variable.name = "trait", value.name = "trait_value")
) %>% na.omit() %>% 
  filter(!(trait %in% c("slope_P50", "branchiness", "branch_Psi12", "branch_Psi88", "HSM_Psimd_Psi88",
                        "branch_vulnerability_slope", "SMleaf", "HSM_Psimd2010_Psi12", "HSM_Psimd2010_Psi50",
                        "HSM_Psimd_Psi12", "HSM_PiTLP_Psi12", "total_sapwood_bulk_elastic_modulus"))) %>% 
  mutate(trait = recode(trait,
                        "P50"	= "xylem pressure inducing 50% loss of hydraulic conductance",			
                        "TLP"	= "leaf water potential at turgor loss point",				
                        "LMA"	= "leaf mass per area",				
                        "leaf_size"	= "leaf area",				
                        "Leaf_N"	= "leaf nitrogen content",				
                        "Leaf_P"	= "leaf phosphorus content",				
                        "Wood_density"	= "trunk wood specific gravity",					
                        "Seed_mass"	= "seed mass",				
                        "max_height"	= "maximum tree height",				
                        "Pi_tlp"	= "leaf water potential at turgor loss point",
                        "sapwood_saturated_water_content"	= "sapwood saturated water content",				
                        "sapwood_osmotic_potential_at_full_turgor"	= "sapwood osmotic potential at full turgor",				
                        "sapwood_water_potential_at_turgor_loss_point"	= "sapwood water potential at turgor loss point",				
                        "total_sapwood_relative_water_content_at_turgor_loss_point"	= "total sapwood relative water content at turgor loss_point",				
                        "sapwood_capacitance_at_full_turgor"	= "sapwood capacitance at full turgor",				
                        "SLA"	= "specific leaf area",				
                        "LDMC"	= "leaf dry matter content",				
                        "LT"	= "leaf thickness",
                        "LA"	= "leaf area",				
                        "CC"	= "chlorophyll content",				
                        "Chlorophyll_content"	= "chlorophyll content",				
                        "Thickness"	= "leaf thickness",				
                        "Toughness"	= "leaf thoughness",				
                        "Leaf_Area"	= "leaf area",				
                        "C"	= "leaf carbon content",				
                        "N"	= "leaf nitrogen content",				
                        "13C"	= "leaf delta 13C",				
                        "Ca"	= "leaf calcium content",	
                        "P"	= "leaf phosphorus content",				
                        "K"	= "leaf potassium content",				
                        "Trunk_bark_thickness"	= "trunk bark thickness",				
                        "Sapwood_WSG"	= "sapwood specific gravity",				
                        "WSG"	= "roots wood specific gravity",				
                        "Diameter"	= "fine roots diameter",				
                        "SRL"	= "specific root length",				
                        "Tissue_density"	= "fine roots tissue density",				
                        "SRTA"	= "specific root tip abundance",				
                        "HSM_PiTLP_Psi88"	= "hydraulic safety margin"))
```

```{r }
all_reg <- all_data %>% 
  filter(trait != "gmax") %>% 
  group_by(dataset, response, trait) %>% 
  do(lm(log(response_value) ~ scale(log(abs(trait_value))), data = .) %>% moderndive::get_regression_table()) %>% 
  filter(term != "intercept") %>% 
  dplyr::select(-term)
```

```{r, fig.height=10, fig.width=8}
all_reg %>% 
  mutate(p_value = ifelse(p_value == 0, 10^-4, p_value)) %>%
  ggplot(aes(x = trait, y = estimate, alpha = p_value < 0.01, fill  = log10(p_value), label = trait)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = .2) +
  geom_hline(yintercept = 0, col = "black") +
  coord_flip() +
  facet_grid(dataset ~ ., scale = "free_y", space = "free_y") +
  viridis::scale_fill_viridis(expression(log[10](p[value])), direction = -1) +
  ylab("Standard estimate with confidence interval") +
  theme(strip.text.y = element_text(angle = 0), axis.title.y = element_blank(), legend.position = "bottom") +
  scale_alpha_discrete(guide = "none")
```

```{r }
t <- all_data %>% 
  filter(dataset == "Vleminckx et al., (2021)") %>% 
  filter(trait %in% filter(all_reg, p_value < 0.01)$trait) %>% 
  group_by(species, trait) %>% 
  summarise(response_value = mean(response_value), trait_value = mean(trait_value)) %>% 
  reshape2::dcast(response_value + species ~ trait, value.var = "trait_value") %>% 
  na.omit() %>% 
  dplyr::select(-species) %>% 
  mutate_all(log) %>% 
  mutate_all(scale) %>% 
  dplyr::rename(gmax = response_value)
```

```{r }
lm(gmax ~ ., data = na.omit(t)) %>%
  step(trace = F) %>%
  sjPlot::tab_model(show.icc = F)
```


```{r }
(lm(gmax ~ ., data = na.omit(t)) %>%
  step(trace = F) %>%
  relaimpo::calc.relimp())@lmg %>% 
  data.frame(trait = names(.), lmg = .) %>% 
  ggplot(aes(reorder(trait, lmg), lmg, label = paste(round(lmg*100), "%"))) +
  geom_col() +
  geom_text(nudge_y = .01) +
  coord_flip() +
  ylab(expression(R^2)) +
  theme(axis.title.y = element_blank())
```


```{r }
all_data %>%  
  filter(dataset == "Vleminckx et al., (2021)") %>% 
  filter(trait %in% filter(all_reg, p_value < 0.01)$trait) %>% 
  filter(!(trait %in% c("leaf phosphorus content", "fine roots tissue density"))) %>% 
  ggplot(aes(trait_value, response_value)) +
  geom_point() +
  facet_wrap(~ trait, scales = "free") +
  scale_x_log10() + scale_y_log10() + geom_smooth(method = "lm") + 
  ylab(expression(Gmax[s]~cm.year^-1)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  scale_color_discrete(guide = "none")
```