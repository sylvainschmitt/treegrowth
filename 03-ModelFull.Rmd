```{r modelfull, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
library(cmdstanr)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
```

# Model full

In this chapter we sample the selected model with full data

## Data

```{r datafulllim, echo=T}
dist_edge <- 20
n_census <- 10
n_ind_species <- 10
```

```{r datafull}
guyafor <- DBI::dbConnect(RSQLite::SQLite(), dbname = "data/guyafor.sql")
trees <- tbl(guyafor, "inventory") %>% 
  filter(Forest == "Paracou") %>% 
  filter(Xfield > local(dist_edge), Xfield < 250-local(dist_edge), 
         Yfield > local(dist_edge), Yfield < 250-local(dist_edge)) %>% 
  mutate(species = paste(Genre, Espece)) %>% 
  collect() %>% 
  filter(!grepl("Indet", species)) %>% 
  mutate(DBH = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  filter(n() > n_census) %>% 
  group_by(species) %>% 
  filter(length(unique(idTree)) > n_ind_species)
DBI::dbDisconnect(guyafor) ; rm(guyafor, dist_edge, n_census, n_in)
```

```{r datafullfig}
trees %>% 
  filter(idTree %in% sample(unique(.$idTree), 20)) %>%
  ggplot(aes(CensusYear, DBH, col = as.factor(idTree))) +
  geom_point(alpha = 0.1) +
  geom_smooth(se = F, alpha = 0.5) +
  scale_y_sqrt() +
  scale_color_discrete(guide = "none") +
  xlab("Census year") + ylab("Diameter at breast height (BDH, cm)")
```

```{r datafulltab}
options(knitr.kable.NA = '')
res <- trees %>% 
  group_by(Family, Genus, species, idTree) %>% 
  summarise(census = n(), year_start = min(CensusYear), year_end = max(CensusYear),
            dbh_start = min(DBH), dbh_end = max(DBH)) %>% 
  ungroup() %>% 
  summarise(n_families = length(unique(Family)),
            n_genera = length(unique(Genus)),
            n_species = length(unique(species)),
            n_individuals = length(unique(idTree)),
            n_observations = nrow(trees),
            min_census = min(census),
            med_census = median(census),
            max_census = max(census),
            min_year0 = min(year_start),
            med_year0 = median(year_start),
            max_year0 = max(year_start),
            min_yearmax = min(year_end),
            med_yearmax = median(year_end),
            max_yearmax = max(year_end),
            min_dbh0 = min(dbh_start),
            med_dbh0 = median(dbh_start),
            max_dbh0 = max(dbh_start),
            min_dbhmax = min(dbh_end),
            med_dbhmax = median(dbh_end),
            max_dbhmax = max(dbh_end))
reshape2::melt(res) %>% 
  separate(variable, c("measure", "variable")) %>% 
  reshape2::dcast(variable ~ measure) %>% 
  dplyr::select(variable, n, med, min, max) %>% 
  mutate(variable = factor(variable, levels = c("families", "genera", "species", "individuals", "observations",
                                                "census", "year0", "yearmax", "dbh0", "dbhmax"))) %>% 
  arrange(variable) %>% 
  kable(col.names = c("", "N", "Median", "Minimum", "Maximum"), format.args = list(big.mark = " "), digits = 0,
        caption = "Metrics on inventory data used to fit the full model including sample size (N), memdian, minimum and maximum values for families, genera, species, individuals, observations, cenusus, recruitment year (year0), last censused year (yearmax), recruitment diameter (dbh0) and last censused diameter (dbhmax).")
rm(res)
```


```{r mdatafull, eval=F}
mdata <- trees %>% 
  group_by(idTree) %>% 
  mutate(Year = CensusYear - min(CensusYear)) %>%
  ungroup() %>% 
  mutate(ind = as.numeric(as.factor(as.character(idTree)))) %>% 
  mutate(sp = as.numeric(as.factor(species)))
vroom::vroom_write(mdata, "save/mdatafull.tsv")
```

```{r mdatafullfig}
mdata <- vroom::vroom("save/mdatafull.tsv")
subdata <- dplyr::select(mdata, sp, ind) %>% 
  unique() %>% 
  filter(sp %in% sample(unique(.$sp), 9)) %>% 
  group_by(sp) %>% 
  sample_n(10) %>% 
  left_join(mdata)
ggplot(subdata, aes(Year, DBH, group = as.factor(ind))) +
  geom_point(col = "grey") +
  geom_smooth(se = F) +
  geom_point(data = filter(subdata, Year == 0), col = "red", size = 2) +
  xlim(0,NA) +
  facet_wrap(~ species)
rm(subdata)
```

## Model

Using time $t$ since recruitment (DBH=10cm) for each individual tree $i$ in species $s$:

$$  DBH_{t,i,s} \sim \mathcal N  (10 + gmax_i \times \sum _{y=1 | DBH_{1,i} = DBH_{recruitment}} ^{y=t} exp(-\frac12.[\frac{log(\frac{DBH_{t,i}}{100.Dopt_s})}{Ks_s}]^2)), \sigma)$$

```{r growthfit, eval=F}
mdata <- vroom::vroom("save/mdatafull.tsv")
growth <- cmdstan_model("model/growth.stan")
fit <- growth$sample(
  data = list(
    N = nrow(filter(mdata, Year > 0)),
    I = max(mdata$ind),
    S = max(mdata$sp),
    Y = max(mdata$Year),
    year = filter(mdata, Year > 0)$Year,
    dbh = filter(mdata, Year > 0)$DBH,
    dbh0 = filter(mdata, Year == 0)$DBH,
    ind = filter(mdata, Year > 0)$ind,
    sp = filter(mdata, Year > 0)$sp
  ),
  chains = 4, 
  parallel_chains = 4,
  refresh = 50,
  save_warmup = F
)
fit$save_output_files(dir = "save/growth")
fit_full <- rstan::read_stan_csv(fit$output_files())
save(fit_full, file = "save/growth.Rdata") 
```
